rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can only read/write their own profile
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create: if request.auth != null && request.auth.uid == uid;
      allow update: if request.auth != null && request.auth.uid == uid
        // Validate score updates are reasonable
        && request.resource.data.totalScore <= 10000000
        && request.resource.data.bestThrow <= 420
        // Scores can only increase (anti-cheat)
        && request.resource.data.totalScore >= resource.data.totalScore
        && request.resource.data.bestThrow >= resource.data.bestThrow;
    }

    // Nicknames - get specific doc only (not list), only createable once per user
    match /nicknames/{nickname} {
      allow get: if true; // Allow checking if nickname exists
      // No list permission (prevents enumeration)
      allow create: if request.auth != null
        && request.resource.data.uid == request.auth.uid
        && nickname.size() >= 3
        && nickname.size() <= 12
        // Only lowercase nicknames allowed (normalize on client)
        && nickname == nickname.lower();
      // No update or delete - nicknames are permanent
    }

    // Leaderboards - readable by all, writable by owner with monotonic scores
    match /leaderboard_total/{uid} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == uid
        && request.resource.data.score <= 10000000
        && request.resource.data.score >= 0;
      allow update: if request.auth != null && request.auth.uid == uid
        && request.resource.data.score <= 10000000
        && request.resource.data.score >= 0
        // Score can only increase
        && request.resource.data.score > resource.data.score;
    }

    match /leaderboard_throw/{uid} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == uid
        && request.resource.data.score <= 420
        && request.resource.data.score >= 0;
      allow update: if request.auth != null && request.auth.uid == uid
        && request.resource.data.score <= 420
        && request.resource.data.score >= 0
        // Score can only increase
        && request.resource.data.score > resource.data.score;
    }

    match /leaderboard_falls/{uid} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == uid
        && request.resource.data.score <= 1000000
        && request.resource.data.score >= 0;
      allow update: if request.auth != null && request.auth.uid == uid
        && request.resource.data.score <= 1000000
        && request.resource.data.score >= 0
        // Falls can only increase
        && request.resource.data.score > resource.data.score;
    }
  }
}
